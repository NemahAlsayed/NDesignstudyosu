{{ define "main" }}

<div class="container posts-wrapper">

  <!-- SEARCH BAR -->
  <div class="posts-search">
    <input type="text" id="searchInput" placeholder="Search posts...">
  </div>

  <!-- BUILD CATEGORY DICTIONARY -->
  {{ $postsByCategory := dict }}
  {{ $allPosts := slice }}

  {{ range .Pages }}
    {{ $page := . }}
    {{ $allPosts = $allPosts | append $page }}

    {{ $categories := .Params.categories | default (slice "Uncategorized") }}

    {{ range $categories }}
      {{ $cat := . }}
      {{ $posts := index $postsByCategory $cat | default slice }}
      {{ $posts = $posts | append $page }}
      {{ $postsByCategory = merge $postsByCategory (dict $cat $posts) }}
    {{ end }}
  {{ end }}

  <!-- SORT CATEGORIES -->
  {{ $sortedCats := slice }}
  {{ range $k, $_ := $postsByCategory }}
    {{ $sortedCats = $sortedCats | append $k }}
  {{ end }}
  {{ $sortedCats = sort $sortedCats }}

  <!-- CATEGORY CHIPS -->
  <div class="category-chips">
    <button class="chip active" data-filter="all">All</button>
    {{ range $sortedCats }}
      <button class="chip" data-filter="{{ . }}">{{ . }}</button>
    {{ end }}
  </div>

  <!-- PAGE TITLE -->
  <h1 class="text-center mb-4">{{ .Title }}</h1>

  <!-- POSTS GRID -->
  <div class="row" id="posts-grid">

    {{ range $allPosts }}
      {{ $page := . }}
      {{ $categories := .Params.categories | default (slice "Uncategorized") }}

      <div class="col-md-6 col-lg-4 mb-4 post-card-wrapper"
           data-category="{{ index $categories 0 }}">

        <div class="card post-card h-100">

          <!-- SMART IMAGE FALLBACK -->
          {{ $img := .Resources.GetMatch .Params.featured_image }}
          {{ if not $img }}
            {{ $img = .Resources.ByType "image" | first }}
          {{ end }}

          {{ with $img }}
            <img loading="lazy" src="{{ .RelPermalink }}" class="post-card-image" alt="{{ $page.Title }}">
          {{ end }}

          <div class="card-body">
            <h5 class="card-title">{{ .Title }}</h5>
            <p class="card-text">{{ .Summary }}</p>
            <a href="{{ .RelPermalink }}" class="btn btn-primary">Read More</a>
          </div>

          <div class="card-footer text-muted">
            {{ .Date.Format "Jan 2, 2006" }}
          </div>

        </div>
      </div>
    {{ end }}

  </div>

</div>

<!-- FILTER + SEARCH JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const chips = document.querySelectorAll(".chip");
  const cards = document.querySelectorAll(".post-card-wrapper");
  const searchInput = document.getElementById("searchInput");

  /* CATEGORY FILTERING */
  chips.forEach(chip => {
    chip.addEventListener("click", () => {

      chips.forEach(c => c.classList.remove("active"));
      chip.classList.add("active");

      const filter = chip.dataset.filter.toLowerCase();

      cards.forEach(card => {
        const category = card.dataset.category.toLowerCase();

        if (filter === "all" || category === filter) {
          card.style.display = "block";
          card.style.opacity = "1";
        } else {
          card.style.opacity = "0";
          setTimeout(() => card.style.display = "none", 200);
        }
      });
    });
  });

  /* SEARCH FILTERING */
  searchInput.addEventListener("input", function () {
    const query = this.value.toLowerCase();

    cards.forEach(card => {
      const title = card.querySelector(".card-title").textContent.toLowerCase();
      const text = card.querySelector(".card-text").textContent.toLowerCase();

      if (title.includes(query) || text.includes(query)) {
        card.style.display = "block";
        card.style.opacity = "1";
      } else {
        card.style.opacity = "0";
        setTimeout(() => card.style.display = "none", 200);
      }
    });
  });

});
</script>

{{ end }}
