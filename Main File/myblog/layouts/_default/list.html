{{ define "main" }}

<div class="container">
  <div class="posts-wrapper mx-auto">

    <!-- Build taxonomy-based category dictionary -->
    {{ $postsByCategory := dict }}
    {{ $allPosts := slice }}

    {{ range .Pages }}
      {{ $page := . }}
      {{ $allPosts = $allPosts | append $page }}

      {{ $categories := .Params.categories | default (slice "Uncategorized") }}

      {{ range $categories }}
        {{ $cat := . }}
        {{ $posts := index $postsByCategory $cat | default slice }}
        {{ $posts = $posts | append $page }}
        {{ $postsByCategory = merge $postsByCategory (dict $cat $posts) }}
      {{ end }}
    {{ end }}

    <!-- Sort categories alphabetically -->
    {{ $sortedCats := slice }}
    {{ range $k, $_ := $postsByCategory }}
      {{ $sortedCats = $sortedCats | append $k }}
    {{ end }}
    {{ $sortedCats = sort $sortedCats }}

    <div class="row">

      <!-- LEFT SIDEBAR -->
      <div class="col-md-3">
        <div class="category-sidebar">
          <h4 class="mb-3">Categories</h4>

          {{ range $sortedCats }}
            <button class="btn filter-btn w-100 text-start mb-2" data-filter="{{ . }}">
              {{ . }}
            </button>
          {{ end }}

          <button class="btn filter-btn w-100 text-start mt-3 active" data-filter="all">
            All Posts
          </button>
        </div>
      </div>

      <!-- RIGHT COLUMN: UNIQUE POSTS -->
      <div class="col-md-9">
        <h1 class="text-center mb-4">{{ .Title }}</h1>

        <div class="row justify-content-center" id="posts-grid">

          {{ range $allPosts }}
            {{ $page := . }}
            {{ $categories := .Params.categories | default (slice "Uncategorized") }}

            <div class="col-md-6 col-lg-4 mb-4 post-card-wrapper"
                 data-category="{{ index $categories 0 }}">

              <div class="card post-card h-100">

                <!-- Correct image loading for page bundles -->
                {{ with .Resources.GetMatch .Params.featured_image }}
                  <img src="{{ .RelPermalink }}" class="card-img-top post-card-image" alt="{{ $page.Title }}">
                {{ end }}

                <div class="card-body">
                  <h5 class="card-title">{{ .Title }}</h5>
                  <p class="card-text">{{ .Summary }}</p>
                  <a href="{{ .RelPermalink }}" class="btn btn-primary">Read More</a>
                </div>

                <div class="card-footer text-muted">
                  {{ .Date.Format "Jan 2, 2006" }}
                </div>

              </div>
            </div>
          {{ end }}

        </div>
      </div>

    </div> <!-- end row -->

  </div>
</div>

<!-- JavaScript Filtering -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const buttons = document.querySelectorAll(".filter-btn");
  const cards = document.querySelectorAll(".post-card-wrapper");

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {

      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const filter = btn.dataset.filter;

      cards.forEach(card => {
        const category = card.dataset.category;

        card.style.opacity = "0";
        setTimeout(() => {
          if (filter === "all" || category === filter) {
            card.style.display = "block";
          } else {
            card.style.display = "none";
          }
          setTimeout(() => {
            card.style.opacity = "1";
          }, 50);
        }, 200);
      });

    });
  });
});
</script>

{{ end }}

