{{ define "main" }}

<div class="container">

  <!-- Page Title -->
  <div class="row">
    <div class="col-12">
      <h1 class="text-center mb-4">{{ .Title }}</h1>
    </div>
  </div>

  <!-- Build category dictionary BEFORE using it -->
  {{ $postsByCategory := dict }}
  {{ range .Pages }}
    {{ $category := .Params.category | default "Uncategorized" }}
    {{ $posts := index $postsByCategory $category | default slice }}
    {{ $posts = $posts | append . }}
    {{ $postsByCategory = merge $postsByCategory (dict $category $posts) }}
  {{ end }}

  <!-- Category Buttons -->
  <div class="row mb-4">
    <div class="col-12 text-center category-buttons">
      <button class="btn btn-outline-primary mx-1 filter-btn active" data-filter="all">All</button>

      {{ range $category, $_ := $postsByCategory }}
        <button class="btn btn-outline-secondary mx-1 filter-btn" data-filter="{{ $category }}">
          {{ $category }}
        </button>
      {{ end }}
    </div>
  </div>

  <!-- Posts Grid -->
  <div class="row justify-content-center" id="posts-grid">

    {{ range $category, $posts := $postsByCategory }}
      {{ range $posts }}
        <div class="col-md-6 col-lg-4 mb-4 post-card-wrapper" data-category="{{ $category }}">
          <div class="card post-card h-100">

            {{ with .Params.featured_image }}
              <img src="{{ . }}" class="card-img-top post-card-image" alt="{{ $.Title }}">
            {{ end }}

            <div class="card-body">
              <h5 class="card-title">{{ .Title }}</h5>
              <p class="card-text">{{ .Summary }}</p>
              <a href="{{ .RelPermalink }}" class="btn btn-primary">Read More</a>
            </div>

            <div class="card-footer text-muted">
              {{ .Date.Format "Jan 2, 2006" }}
            </div>

          </div>
        </div>
      {{ end }}
    {{ end }}

  </div>

</div>

<!-- JavaScript Filtering -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const buttons = document.querySelectorAll(".filter-btn");
  const cards = document.querySelectorAll(".post-card-wrapper");

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {

      // Highlight active button
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const filter = btn.dataset.filter;

      cards.forEach(card => {
        const category = card.dataset.category;

        // Fade out
        card.style.opacity = "0";
        setTimeout(() => {
          if (filter === "all" || filter === category) {
            card.style.display = "block";
          } else {
            card.style.display = "none";
          }
          // Fade in
          setTimeout(() => {
            card.style.opacity = "1";
          }, 50);
        }, 200);
      });

    });
  });
});
</script>

{{ end }}
